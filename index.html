<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        input, button {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }
        img {
            margin-top: 20px;
            max-width: 100%;
            height: auto;
        }
        #progressBar {
            width: 10%;
            height: 80px;
            margin-top: 10px;
        }
		#gallery {
			width: 80%;
		}
    </style>
</head>
<body>
    <h1>Generator obrazów</h1>
    <input type="text" id="uid" placeholder="UID" />
    <label for="modelSelect">Model</label>
    <select id="modelSelect">
        <option value="sd3.5_large_fp8_scaled.safetensors">Stable Diffusion 3.5 Large (fp8)</option>
        <option value="sd_xl_base_1.0.safetensors">Stable Diffusion XL</option>
        <option value="sd_xl_turbo_1.0_fp16.safetensors">Stable Diffusion XL Turbo (fp16)</option>
    </select>
    <label for="positivePrompt">Positive Prompt</label>
    <input type="text" id="positivePrompt" placeholder="Elvish sword" />
    <label for="negativePrompt">Negative Prompt</label>
    <input type="text" id="negativePrompt" placeholder="Bad" />
    <label for="samplerSelect">Sampler</label>
    <select id="samplerSelect">
		<option value="euler">euler</option>
		<option value="euler_cfg_pp">euler_cfg_pp</option>
		<option value="euler_ancestral">euler_ancestral</option>
		<option value="euler_ancestral_cfg_pp">euler_ancestral_cfg_pp</option>
		<option value="heun">heun</option>
		<option value="heunpp2">heunpp2</option>
		<option value="dpm_2">dpm_2</option>
		<option value="dpm_2_ancestral">dpm_2_ancestral</option>
		<option value="lms">lms</option>
		<option value="dpm_fast">dpm_fast</option>
		<option value="dpm_adaptive">dpm_adaptive</option>
		<option value="dpmpp_2s_ancestral">dpmpp_2s_ancestral</option>
		<option value="dpmpp_2s_ancestral_cfg_pp">dpmpp_2s_ancestral_cfg_pp</option>
		<option value="dpmpp_sde">dpmpp_sde</option>
		<option value="dpmpp_sde_gpu">dpmpp_sde_gpu</option>
		<option value="dpmpp_2m">dpmpp_2m</option>
		<option value="dpmpp_2m_cfg_pp">dpmpp_2m_cfg_pp</option>
		<option value="dpmpp_2m_sde">dpmpp_2m_sde</option>
		<option value="dpmpp_2m_sde_gpu">dpmpp_2m_sde_gpu</option>
		<option value="dpmpp_3m_sde">dpmpp_3m_sde</option>
		<option value="dpmpp_3m_sde_gpu">dpmpp_3m_sde_gpu</option>
		<option value="ddpm">ddpm</option>
		<option value="lcm">lcm</option>
		<option value="ipndm">ipndm</option>
		<option value="ipndm_v">ipndm_v</option>
		<option value="deis">deis</option>
		<option value="res_multistep">res_multistep</option>
		<option value="res_multistep_cfg_pp">res_multistep_cfg_pp</option>
		<option value="res_multistep_ancestral">res_multistep_ancestral</option>
		<option value="res_multistep_ancestral_cfg_pp">res_multistep_ancestral_cfg_pp</option>
		<option value="gradient_estimation">gradient_estimation</option>
		<option value="er_sde">er_sde</option>
		<option value="ddim">ddim</option>
		<option value="uni_pc">uni_pc</option>
		<option value="uni_pc_bh2">uni_pc_bh2</option>
	</select>
	<label for="schedulerSelect">Scheduler</label>
	<select id="schedulerSelect">
		<option value="normal">normal</option>
		<option value="kerras">kerras</option>
		<option value="exponential">exponential</option>
		<option value="sgm_uniform">sgm_uniform</option>
		<option value="simple">simple</option>
		<option value="ddim_uniform">ddim_uniform</option>
		<option value="beta">beta</option>
		<option value="linear_quadratic">linear_quadratic</option>
		<option value="kl_optimal">kl_optimal</option>
	</select>
    <label for="cfgInput">CFG</label>
    <input type="number" id="cfgInput" min="1" max="20" step="0.1" value="2" />
    <label for="stepsInput">Steps</label>
    <input type="number" id="stepsInput" min="20" max="70" step="1" value="50" />
    <label id= "stepsRefineLabel" for="stepsRefineInput" hidden="true">Refiner Steps</label>
    <input type="number" id="stepsRefineInput" min="20" max="70" step="1" value="50" hidden="true" />
	<label for="progressBar" id="progressName"></label>
    <progress id="progressBar" value="0" max="100"></progress>
    <button id="submitButton">Prześlij</button>
    <div id="output"></div>
	<button id="reloadGallery">Załaduj obrazy</button>
	<div id="gallery"></div>
	<div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center; z-index: 1000;">
		<img id="modalImage" style="max-width: 90%; max-height: 90%; border: 2px solid white; border-radius: 10px;" />
	</div>

    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@stable-canvas/comfyui-client@latest/dist/main.module.mjs";

		// TO-DO
		// Zastanowić się nad WebSocket w przypadku problemów
		// Zastanowić się nad większą ilością modeli/workflow
		// Zastanowić się nad przeniesieniem javascript do osobnego pliku
		// Wykonać FrontEnd jakiś ładny

        // Inicjalizacja klienta
        const client = new Client({
            api_host: "qbsoonw11:8000", // Adres i port serwera ComfyUI
        });

        try {
			client.connect()
   			console.log('Connected to ComfyUI server');
		} catch (error) {
    		console.error('Failed to connect to ComfyUI server:', error);
		}

        function validateInputs() {
            const positivePrompt = document.getElementById('positivePrompt').value.trim();
            const cfgInput = parseFloat(document.getElementById('cfgInput').value);
            const stepsInput = parseInt(document.getElementById('stepsInput').value);
            const stepsRefineInput = parseInt(document.getElementById('stepsRefineInput').value);
            var stepsMaxLimit = 140

            if (document.getElementById('modelSelect').value === 'sd_xl_turbo_1.0_fp16.safetensors') {
                stepsMaxLimit = 10
            }

            if (!positivePrompt) {
                alert('Positive Prompt jest wymagany.');
                return;
            }

            if (isNaN(cfgInput) || cfgInput < 1.0 || cfgInput > 20.0) {
                alert('CFG musi być liczbą pomiędzy 1.0 a 20.0.');
                return;
            }

            if (isNaN(stepsInput) || stepsInput < 1 || stepsInput > stepsMaxLimit || !Number.isInteger(stepsInput)) {
                alert('Steps musi być liczbą całkowitą pomiędzy 1 a ' + stepsMaxLimit + '.');
                return;
            }

            if (isNaN(stepsRefineInput) || stepsRefineInput < 1 || stepsRefineInput > 100 || !Number.isInteger(stepsRefineInput)) {
                alert('Refiner Steps musi być liczbą całkowitą pomiędzy 1 a 100.');
                return;
            }

            setWorkflow();
        }

        function updateProgressBar(value, max) {
            const progressBar = document.getElementById('progressBar');
			const progressName = document.getElementById('progressName');
            const percentage = (value / max) * 100;
            progressBar.value = percentage;
			if (percentage > 0 && percentage < 100) {
				progressName.innerText = `Postęp: ${Math.round(percentage)}%`;
			} else if (percentage == 100) {
				progressName.innerText = 'Generowanie zakończone';
			} else {
				progressName.innerText = '';
			}
		}

        function changeModel() {
            if (document.getElementById('modelSelect').value === 'sd_xl_base_1.0.safetensors') {
                document.getElementById('stepsRefineInput').hidden = false;
                document.getElementById('stepsRefineLabel').hidden = false;
            }
            if (document.getElementById('modelSelect').value === 'sd3.5_large_fp8_scaled.safetensors' || document.getElementById('modelSelect').value === 'sd_xl_turbo_1.0_fp16.safetensors') {
                document.getElementById('stepsRefineInput').hidden = true;
                document.getElementById('stepsRefineLabel').hidden = true;
            }
        }

		async function loadWorkflow(file) {
		    try {
		        const response = await fetch(`workflows/${file}`);
		        if (!response.ok) {
		            throw new Error(`Failed to load workflow JSON: ${response.statusText}`);
		        }
		        const workflow = await response.json();
		        console.log('Loaded Workflow:', file);
				// Wspólne ustawienia workflow
				workflow["6"].inputs.text = document.getElementById('positivePrompt').value;
				workflow["7"].inputs.text = document.getElementById('negativePrompt').value;
		        return workflow;
		    } catch (error) {
		        console.error('Error loading workflow JSON:', error);
		    }
		}

        async function setWorkflow() {
			const promptP = document.getElementById('positivePrompt').value.trim();
			const promptN = document.getElementById('negativePrompt').value.trim();
            const cfg = parseFloat(document.getElementById('cfgInput').value);
            const steps = parseInt(document.getElementById('stepsInput').value);
            const stepsRefine = parseInt(document.getElementById('stepsRefineInput').value);
            const sampler = document.getElementById('samplerSelect').value;
			const scheduler = document.getElementById('schedulerSelect').value;
            const uid = document.getElementById('uid').value.trim();
			console.log('UID:', uid);

			let workflow;

            if (document.getElementById('modelSelect').value === 'sd_xl_base_1.0.safetensors') {
                workflow = await loadWorkflow('SDXL.json');
				workflow["10"].inputs.steps = stepsRefine+steps;
				workflow["10"].inputs.cfg = cfg;
				workflow["10"].inputs.sampler_name = sampler;
				workflow["10"].inputs.end_at_step = steps;
				workflow["10"].inputs.scheduler = scheduler;
				workflow["11"].inputs.steps = stepsRefine+steps;
				workflow["11"].inputs.cfg = cfg;
				workflow["11"].inputs.sampler_name = sampler;
				workflow["11"].inputs.start_at_step = steps;
				workflow["11"].inputs.scheduler = scheduler;
				workflow["15"].inputs.text = promptP;
				workflow["16"].inputs.text = promptN;
				workflow["19"].inputs.filename_prefix = `${uid}\\sdxl`;
			} else if (document.getElementById('modelSelect').value === 'sd3.5_large_fp8_scaled.safetensors') {
                workflow = await loadWorkflow('SD35.json');
				workflow["3"].inputs.cfg = cfg;
				workflow["3"].inputs.sampler_name = sampler;
				workflow["3"].inputs.steps = steps;
				workflow["3"].inputs.scheduler = scheduler;
				workflow["9"].inputs.filename_prefix = `${uid}\\sd35`;
            } else if (document.getElementById('modelSelect').value === 'sd_xl_turbo_1.0_fp16.safetensors') {
                workflow = await loadWorkflow('SDXLTurbo.json');
				workflow["13"].inputs.cfg = cfg;
				workflow["14"].inputs.sampler_name = sampler;
				workflow["22"].inputs.steps = steps;
				workflow["19"].inputs.filename_prefix = `${uid}\\sdxlturbo`;
            }
			generateImage(workflow);
        }
        async function generateImage(workflow) {
            try {
                // Wysłanie zapytania do kolejki serwera ComfyUI
				console.log('Sending workflow to ComfyUI');
                const result = await client.enqueue(workflow, {
 					progress: ({max,value}) => updateProgressBar(value, max),
				});

				console.log('Result received from ComfyUI:', result);
            
                // Sprawdzenie, czy odpowiedź zawiera dane obrazu
                if (!result || !result.images || result.images.length === 0) {
                    throw new Error('No image data returned from the server.');
                }
                console.log(result)
                // Wydobycie adresu URL obrazu z odpowiedzi
                const imageUrl = result.images[0].data;

				console.log('Image URL:', imageUrl);
            
                const img = document.createElement('img');
                img.src = imageUrl;
            
                // Obsługa błędów
                img.onerror = () => {
                    alert('Failed to load the generated image. Please check the server response.');
                };
            
                // Wyświetlenie nowego obrazu
                const outputDiv = document.getElementById('output');
                outputDiv.innerHTML = '';
                outputDiv.appendChild(img);
				document.getElementById('reloadGallery').click();
            } catch (error) {
                console.error('Error generating image:', error);
                alert('Failed to generate image. Check the console for details.');
            }
        }

        window.loadImages = async function(directory) {
		    try {
		        const response = await fetch(directory);
		        if (!response.ok) {
		            throw new Error(`Failed to load directory: ${response.statusText}`);
		        }
			
		        const html = await response.text();
		        const parser = new DOMParser();
		        const doc = parser.parseFromString(html, 'text/html');
			
		        // Znajdź wszystkie linki do plików w katalogu
		        const images_raw = Array.from(doc.querySelectorAll('tr'));
		        const images = images_raw
		            .map(image => {
		                const link = image.querySelector('a');
		                const imageDate = image.querySelector('td:nth-child(3)');
		                if (link && imageDate) {
		                    return {
		                        name: link.getAttribute('href'),
		                        date: new Date(imageDate.textContent.trim())
		                    };
		                }
		                return null;
		            })
		            .filter(image => image && /\.(jpg|jpeg|png)$/i.test(image.name)); // Filtruj tylko obrazy
				
		        // Sort files by modification date (newest first)
		        images.sort((a, b) => b.date - a.date);
				
		        const outputDiv = document.getElementById('gallery');
		        outputDiv.innerHTML = ''; // Wyczyść poprzednie obrazy
				
		        images.forEach(image => {
    	            const img = document.createElement('img');
    	            img.src = `${directory}/${image.name}`;
    	            img.alt = image;
    	            img.style.margin = '10px';
    	            img.style.maxWidth = '200px';
    	            img.style.height = 'auto';

					// Add click event to open the modal
					img.addEventListener('click', () => {
						const modal = document.getElementById('imageModal');
						const modalImage = document.getElementById('modalImage');
						modalImage.src = img.src; // Set the modal image source to the clicked image
						modal.style.display = 'flex'; // Show the modal
					});

					// Close modal when clicking outside the image
					document.getElementById('imageModal').addEventListener('click', (event) => {
					    const modal = document.getElementById('imageModal');
					    const modalImage = document.getElementById('modalImage');
					
					    // Close the modal only if the click is outside the image
					    if (event.target !== modalImage) {
					        modal.style.display = 'none';
					    }
					});

    	            outputDiv.appendChild(img);
    	        });
    	    } catch (error) {
    	        console.error('Error loading images:', error);
    	        alert('Nie udało się załadować obrazów.');
    	    }
    	}


		document.getElementById('submitButton').addEventListener('click', () => {
    		validateInputs();
		});
        document.getElementById('modelSelect').addEventListener('change', changeModel);
		document.getElementById('reloadGallery').addEventListener('click', () => {
			const uid = document.getElementById('uid').value.trim();
			loadImages(`http://qbsoonw11:80/gallery/${uid}`);
		});
    </script>
</body>
</html>